<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seguimiento de Rutina de Musculación</title>
    <!-- Carga de Tailwind CSS --><script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Fuente Inter para estética */
        :root { font-family: 'Inter', sans-serif; }
        /* Estilos para el botón de completar */
        .complete-button {
            transition: all 0.2s;
        }
        .completed {
            background-color: #10B981; /* Esmeralda 500 */
            color: white;
            pointer-events: none; /* Deshabilitar clics una vez completado */
        }
        /* Estilos para el modal de imagen */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.8);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            margin: auto;
            display: block;
            width: 80%;
            max-width: 700px;
        }
        .modal-content, #caption {
            animation-name: zoom;
            animation-duration: 0.6s;
        }
        @keyframes zoom {
            from {transform: scale(0.1)} 
            to {transform: scale(1)}
        }
        .close {
            position: absolute;
            top: 15px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            transition: 0.3s;
        }
        .close:hover,
        .close:focus {
            color: #bbb;
            text-decoration: none;
            cursor: pointer;
        }
        /* Estilo para el spinner de carga */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #4f46e5; /* Color índigo */
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 sm:p-8">

    <div class="max-w-4xl mx-auto bg-white shadow-xl rounded-xl p-6 sm:p-10">
        <!-- Título y Selector de Día -->
        <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-800 mb-2">Mi Rutina de Musculación</h1>
        <p class="text-gray-600 mb-6 border-b pb-4">Seguimiento de Lunes a Viernes (Máx. 50 min/sesión).</p>

        <!-- Selector de Día -->
        <div class="flex flex-wrap gap-2 mb-8" id="day-selector-container">
            <!-- Los botones se insertarán aquí por JS -->
        </div>

        <!-- Encabezado del Día Actual -->
        <div class="bg-indigo-600 text-white p-4 rounded-t-lg shadow-md flex justify-between items-center">
            <h2 class="text-xl font-bold" id="current-day-title"></h2>
            <span class="text-sm font-light italic" id="day-focus"></span>
        </div>

        <!-- Lista de Ejercicios -->
        <div id="exercise-list-container" class="border border-gray-200 rounded-b-lg p-4 divide-y divide-gray-100">
            <!-- La rutina se insertará aquí por JS -->
        </div>

        <!-- Instrucciones -->
        <p class="mt-8 text-sm text-gray-500">
            * Haz clic en el botón "Completar" para marcar el ejercicio realizado. El progreso se restablece al recargar la página.
            <br>
            * Haz clic en la imagen del ejercicio para verla en grande.
        </p>
    </div>

    <!-- The Modal -->
    <div id="myModal" class="modal">
        <span class="close" onclick="document.getElementById('myModal').style.display='none'">&times;</span>
        <img class="modal-content" id="img01">
    </div>

    <script>
        const routine = {
            "LUNES": {
                focus: "Empuje Superior y Pierna",
                exercises: [
                    { name: "Calentamiento (Cardio y Movilidad)", setsReps: "1 x 5 min", desc: "5 minutos de cardio suave (cinta/elíptica) y movimientos articulares para preparar músculos y articulaciones.", image_prompt: "mujer en un gimnasio haciendo calentamiento cardiovascular ligero en una cinta, enfoque en el ejercicio, estilo fotografía de stock, render 3D de alta calidad" },
                    { name: "Prensa de Piernas", setsReps: "3 x 10-12", desc: "Empuja la plataforma con fuerza, enfocándote en la contracción de cuádriceps y glúteos. Controla el peso al bajar.", image_prompt: "persona haciendo prensa de piernas en máquina de gimnasio, vista lateral, movimiento de la máquina de pesas, fotografía de stock" },
                    { name: "Press de Banca con Mancuernas", setsReps: "3 x 8-10", desc: "Acuéstate en el banco y empuja las mancuernas hacia arriba, buscando un rango de movimiento profundo para trabajar el pecho.", image_prompt: "hombre haciendo press de banca con mancuernas en un banco plano, vista frontal, ejercicio de fuerza, fotografía de stock" },
                    { name: "Extensión de Cuádriceps (Máquina)", setsReps: "3 x 12-15", desc: "Siéntate y extiende las piernas, aislando el músculo cuádriceps en la parte delantera.", image_prompt: "persona haciendo extensión de cuádriceps en máquina de gimnasio, aislado, fotografía de stock" },
                    { name: "Press Militar con Mancuernas (Sentado)", setsReps: "3 x 10", desc: "Sube las mancuernas por encima de la cabeza de manera controlada. Excelente para hombros (deltoides).", image_prompt: "persona haciendo press militar sentado con mancuernas, vista de 3/4 en un banco de gimnasio, estilo fotografía de stock" },
                    { name: "Extensiones de Tríceps (Polea Alta)", setsReps: "3 x 12-15", desc: "Empuja la barra hacia abajo, sintiendo la contracción del tríceps al final del movimiento.", image_prompt: "persona haciendo extensión de tríceps en polea alta con barra, vista de 3/4, enfoque en la técnica, render 3D" }
                ]
            },
            "MARTES": {
                focus: "Tirón Superior y Abdomen",
                exercises: [
                    { name: "Calentamiento (Cardio y Movilidad)", setsReps: "1 x 5 min", desc: "5 minutos de cardio suave y movilidad de hombros y espalda.", image_prompt: "mujer haciendo calentamiento general, estiramientos de hombros y espalda en un gimnasio, fotografía de stock" },
                    { name: "Jalón al Pecho (Polea Alta)", setsReps: "3 x 10-12", desc: "Tira de la barra hacia el pecho, enfocándote en llevar los codos hacia atrás para contraer la espalda (ancho).", image_prompt: "hombre haciendo jalón al pecho en máquina de polea alta en un gimnasio, concentrado, render 3D de alta calidad" },
                    { name: "Remo en Máquina o Polea Baja", setsReps: "3 x 10-12", desc: "Tira hacia tu abdomen manteniendo la espalda recta y saca pecho. Trabaja el grosor de la espalda.", image_prompt: "persona haciendo remo sentado en máquina de polea baja, vista lateral, enfoque en la contracción de espalda, fotografía de stock" },
                    { name: "Flexión de Bíceps con Barra EZ", setsReps: "3 x 10", desc: "Flexiona los brazos sin mover los codos, aislando el bíceps. Evita el impulso del cuerpo.", image_prompt: "hombre haciendo curl de bíceps con barra EZ, de pie, en primer plano, fotografía de stock" },
                    { name: "Pájaro (Elevación Posterior)", setsReps: "3 x 15", desc: "Inclínate (casi paralelo al suelo) y eleva las mancuernas hacia los lados para trabajar la parte posterior del hombro.", image_prompt: "mujer haciendo elevaciones posteriores (pájaro) con mancuernas, inclinada hacia adelante, vista lateral, fotografía de stock" },
                    { name: "Plancha (Plank)", setsReps: "3 x 45-60 seg", desc: "Mantén el cuerpo recto como una tabla, contrayendo fuertemente el abdomen y glúteos (Core).", image_prompt: "persona haciendo plancha (plank) correctamente, vista lateral, sobre una colchoneta, render 3D" }
                ]
            },
            "MIÉRCOLES": {
                focus: "Pierna Completa",
                exercises: [
                    { name: "Calentamiento (Cardio y Movilidad)", setsReps: "1 x 5 min", desc: "5 minutos de cardio suave y estiramiento dinámico de piernas.", image_prompt: "mujer haciendo calentamiento con estiramientos dinámicos de piernas en el gimnasio, estilo fotografía de stock" },
                    { name: "Sentadilla en Multipower o Hack", setsReps: "3 x 10", desc: "Utiliza la máquina para estabilizar el movimiento y enfocarte en bajar hasta que el muslo esté paralelo al suelo.", image_prompt: "persona haciendo sentadilla en máquina multipower o hack squat en un gimnasio, vista lateral, estilo de entrenamiento de fuerza" },
                    { name: "Curl Femoral (Tumbado o Sentado)", setsReps: "3 x 12-15", desc: "Flexiona la pierna hacia el glúteo para aislar los isquiotibiales (parte trasera del muslo).", image_prompt: "persona haciendo curl femoral en máquina, tumbada boca abajo, enfoque en las piernas, fotografía de stock" },
                    { name: "Zancadas Estáticas con Mancuernas", setsReps: "3 x 10-12 (por pierna)", desc: "Mantente estático en posición de zancada, bajando y subiendo. Mantiene la rodilla de adelante alineada con el tobillo.", image_prompt: "mujer haciendo zancadas estáticas con mancuernas, vista lateral, buena forma, fotografía de stock" },
                    { name: "Elevación de Gemelos (Máquina)", setsReps: "3 x 15-20", desc: "Baja completamente los talones y sube todo lo posible, concentrándose en el rango de movimiento.", image_prompt: "persona haciendo elevación de gemelos en máquina de gimnasio, de pie, con peso en los hombros, render 3D" },
                    { name: "Elevación de Glúteos en el Suelo (Glute Bridge)", setsReps: "3 x 12-15", desc: "Acuéstate boca arriba, rodillas flexionadas. Empuja la cadera hacia el techo contrayendo los glúteos. Puedes añadir una mancuerna sobre la cadera para más intensidad.", image_prompt: "persona haciendo elevación de glúteos en el suelo (glute bridge) con una mancuerna sobre la cadera, vista lateral, render 3D, fondo de gimnasio" }
                ]
            },
            "JUEVES": {
                focus: "Empuje y Tirón General",
                exercises: [
                    { name: "Calentamiento (Cardio y Movilidad)", setsReps: "1 x 5 min", desc: "5 minutos de cardio suave y movimientos circulares de hombros.", image_prompt: "hombre haciendo calentamiento con círculos de hombros y estiramientos ligeros en el gimnasio, fotografía de stock" },
                    { name: "Press Inclinado (Mancuernas)", setsReps: "3 x 8-10", desc: "Acuéstate en el banco inclinado y empuja las mancuernas, dando énfasis a la parte superior del pecho.", image_prompt: "persona haciendo press inclinado con mancuernas en banco inclinado, vista frontal, ejercicio de pecho, render 3D" },
                    { name: "Remo con Barra (Agarre Supino)", setsReps: "3 x 10", desc: "Tira la barra hacia el abdomen con el agarre de palma hacia arriba. Fortalece la espalda baja/media.", image_prompt: "persona haciendo remo con barra (agarre supino), inclinada hacia adelante, enfoque en la espalda, fotografía de stock" },
                    { name: "Elevaciones Laterales (Mancuernas)", setsReps: "3 x 12-15", desc: "Levanta las mancuernas hacia los lados, manteniendo los brazos casi rectos. Para los hombros laterales. Peso ligero.", image_prompt: "mujer haciendo elevaciones laterales con mancuernas, de pie, vista lateral, fotografía de stock" },
                    { name: "Face Pull (Tirón a la Cara)", setsReps: "3 x 15", desc: "Tira de una cuerda hacia tu cara en la polea. Fortalece el manguito rotador y mejora la postura.", image_prompt: "persona haciendo face pull (tirón a la cara) en polea con cuerda, enfoque en la cara y los hombros, render 3D" },
                    { name: "Superserie Bíceps/Tríceps", setsReps: "3 x 10 / 12", desc: "Realiza Curl Martillo (bíceps) inmediatamente seguido de Fondos en Banco (tríceps). Descansa solo al terminar ambos.", image_prompt: "hombre haciendo curl martillo de bíceps y fondos en banco para tríceps como superserie, ilustración de ejercicios" }
                ]
            },
            "VIERNES": {
                focus: "Refuerzo y Cardio HIIT",
                exercises: [
                    { name: "Calentamiento (Cardio)", setsReps: "1 x 5 min", desc: "5 minutos de cardio para preparar el cuerpo para el entrenamiento de alta intensidad.", image_prompt: "persona haciendo calentamiento en bicicleta estática o elíptica en un gimnasio, fotografía de stock" },
                    { name: "Peso Muerto Rumano (Mancuernas)", setsReps: "3 x 10-12", desc: "Mantén las rodillas semi-flexionadas y baja las mancuernas deslizando la cadera hacia atrás. Estira femorales y glúteos.", image_prompt: "mujer haciendo peso muerto rumano con mancuernas, vista lateral, enfoque en la forma y los isquiotibiales, fotografía de stock" },
                    { name: "Abdominales en Cable (Polea Alta)", setsReps: "3 x 15-20", desc: "Arrodíllate frente a la polea y flexiona el torso hacia el suelo, concentrándote en el abdomen.", image_prompt: "persona haciendo abdominales en cable (crunch de rodillas con cable), enfoque en el core, render 3D" },
                    { name: "Extensión de Tríceps por Encima de la Cabeza", setsReps: "3 x 12", desc: "Sujeta una mancuerna o barra con ambas manos y bájala detrás de la cabeza, estirando el tríceps.", image_prompt: "hombre haciendo extensión de tríceps por encima de la cabeza con una mancuerna, sentado en un banco, fotografía de stock" },
                    { name: "Máquina de Abducción de Cadera", setsReps: "3 x 15-20", desc: "Empuja las piernas hacia afuera, trabajando la parte lateral de los glúteos.", image_prompt: "mujer haciendo abducción de cadera en máquina de gimnasio, vista lateral, concentrada, fotografía de stock" },
                    { name: "Cardio de Alta Intensidad (HIIT)", setsReps: "8 x 1 min", desc: "Alterna 30 segundos de sprint (máximo esfuerzo) con 30 segundos de caminata rápida en la cinta (recuperación). Total: 8 minutos.", image_prompt: "persona haciendo sprint en una cinta de correr durante un entrenamiento HIIT, vista de primer plano en la acción, fotografía de stock" }
                ]
            }
        };

        const dayNames = { 1: "LUNES", 2: "MARTES", 3: "MIÉRCOLES", 4: "JUEVES", 5: "VIERNES" };
        const weekDays = ["LUNES", "MARTES", "MIÉRCOLES", "JUEVES", "VIERNES"];

        const listContainer = document.getElementById('exercise-list-container');
        const titleElement = document.getElementById('current-day-title');
        const focusElement = document.getElementById('day-focus');
        const daySelectorContainer = document.getElementById('day-selector-container');
        
        let completedExercises = {};

        // Get the modal and image elements
        const modal = document.getElementById("myModal");
        const modalImg = document.getElementById("img01");

        function openModal(imgSrc) {
            modal.style.display = "flex";
            modalImg.src = imgSrc;
        }

        // --- Funciones para la API de Generación de Imágenes y Backoff ---

        const API_KEY = ""; // La clave se proporciona en el entorno de Canvas
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${API_KEY}`;

        // Utilidad para manejar reintentos con backoff exponencial
        async function fetchWithBackoff(url, options, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) {
                        return response;
                    }
                    if (response.status === 429 || response.status >= 500) {
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }
                    throw new Error(`Error en la API: ${response.statusText}`);
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        async function generateImage(prompt) {
            const payload = { 
                instances: { 
                    prompt: `Imagen de ejercicio de gimnasio: ${prompt}` 
                }, 
                parameters: { 
                    "sampleCount": 1,
                    "aspectRatio": "1:1" // Cuadrado para el thumbnail
                } 
            };
            
            try {
                const response = await fetchWithBackoff(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                
                if (result.predictions && result.predictions.length > 0 && result.predictions[0].bytesBase64Encoded) {
                    const base64Data = result.predictions[0].bytesBase64Encoded;
                    return `data:image/png;base64,${base64Data}`;
                } else {
                    console.error("Respuesta de la API incompleta:", result);
                    return null; 
                }
            } catch (error) {
                console.error("Error al generar la imagen para el prompt:", prompt, error);
                return null;
            }
        }
        
        // Función asíncrona para cargar la imagen y reemplazar el placeholder
        async function loadAndDisplayImage(exerciseId, prompt) {
            const imgContainer = document.getElementById(`img-container-${exerciseId}`);
            if (!imgContainer) return;

            // 1. Mostrar Spinner
            imgContainer.innerHTML = '<div class="spinner"></div>';
            
            // 2. Generar Imagen
            const imageUrl = await generateImage(prompt);
            
            // 3. Reemplazar
            if (imageUrl) {
                imgContainer.innerHTML = `
                    <img 
                        src="${imageUrl}" 
                        alt="Ilustración del ejercicio" 
                        class="w-full h-full object-cover rounded-md cursor-pointer shadow-sm" 
                        onerror="this.onerror=null; this.src='https://placehold.co/96x96/f87171/ffffff?text=Error';"
                        onclick="openModal('${imageUrl}')"
                    >
                `;
            } else {
                imgContainer.innerHTML = `
                    <div class="text-xs text-red-500 text-center p-2">
                        No disponible
                    </div>
                `;
                imgContainer.classList.add('bg-red-100', 'border', 'border-red-300');
            }
        }

        // Función para renderizar el día seleccionado
        function renderRoutine(dayKey) {
            const dayData = routine[dayKey];
            if (!dayData) {
                listContainer.innerHTML = '<p class="p-4 text-center text-gray-500">¡Hoy es fin de semana! Día de descanso activo. Selecciona otro día si quieres ver la rutina.</p>';
                titleElement.textContent = `¡FIN DE SEMANA! (${dayKey})`;
                focusElement.textContent = '';
                return;
            }

            titleElement.textContent = `Rutina de ${dayKey}`;
            focusElement.textContent = `Foco: ${dayData.focus}`;
            listContainer.innerHTML = ''; // Limpiar el contenedor

            dayData.exercises.forEach((ex, index) => {
                const exerciseId = `${dayKey}-${index}`;
                const isCompleted = completedExercises[exerciseId];

                const exerciseDiv = document.createElement('div');
                exerciseDiv.className = 'p-5 flex flex-col md:flex-row justify-between items-start md:items-center hover:bg-indigo-50 transition duration-150';
                
                // Placeholder para la imagen
                const imageHtml = `
                    <div id="img-container-${exerciseId}" class="w-24 h-24 flex items-center justify-center rounded-md bg-gray-200 shrink-0">
                        <div class="text-xs text-gray-500">Cargando...</div>
                    </div>
                `;

                exerciseDiv.innerHTML = `
                    <div class="mb-3 md:mb-0 md:w-3/5">
                        <h3 class="text-lg font-semibold text-gray-900">${index + 1}. ${ex.name}</h3>
                        <p class="text-sm text-gray-500 mt-1">${ex.desc}</p>
                    </div>
                    <div class="flex flex-col items-center gap-4 md:w-2/5 md:justify-end">
                        ${imageHtml}
                        <span class="text-sm font-medium text-indigo-600 w-24 text-center">${ex.setsReps}</span>
                        <button 
                            data-exercise-id="${exerciseId}"
                            class="complete-button py-2 px-4 rounded-full text-sm font-bold shadow-md w-32 
                                ${isCompleted ? 'completed' : 'bg-green-100 text-green-700 hover:bg-green-200'}"
                            onclick="toggleCompletion('${exerciseId}', this)"
                            ${isCompleted ? 'disabled' : ''}
                        >
                            ${isCompleted ? '✅ Completado' : 'Completar'}
                        </button>
                    </div>
                `;
                listContainer.appendChild(exerciseDiv);

                // Llamada asíncrona para cargar la imagen después de que el elemento existe en el DOM
                if (ex.image_prompt) {
                    loadAndDisplayImage(exerciseId, ex.image_prompt);
                }
            });
            updateDaySelector(dayKey);
        }

        // Función para cambiar el estado de completado
        function toggleCompletion(exerciseId, buttonElement) {
            if (!completedExercises[exerciseId]) {
                completedExercises[exerciseId] = true;
                buttonElement.textContent = '✅ Completado';
                buttonElement.classList.add('completed');
                buttonElement.classList.remove('bg-green-100', 'text-green-700', 'hover:bg-green-200');
            }
        }

        // Función para generar los botones de selección de día
        function createDaySelector() {
            weekDays.forEach(day => {
                const button = document.createElement('button');
                button.textContent = day;
                button.className = 'day-selector-btn py-2 px-4 rounded-lg text-sm font-semibold transition duration-150';
                button.setAttribute('data-day', day);
                button.onclick = () => renderRoutine(day);
                daySelectorContainer.appendChild(button);
            });
        }

        // Función para actualizar el estilo del botón seleccionado
        function updateDaySelector(currentDay) {
            document.querySelectorAll('.day-selector-btn').forEach(btn => {
                btn.classList.remove('bg-indigo-600', 'text-white');
                btn.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                if (btn.getAttribute('data-day') === currentDay) {
                    btn.classList.add('bg-indigo-600', 'text-white');
                    btn.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                }
            });
        }

        // Función para determinar el día actual
        function getToday() {
            const date = new Date();
            const dayIndex = date.getDay(); 
            
            let todayKey;
            if (dayIndex >= 1 && dayIndex <= 5) {
                todayKey = dayNames[dayIndex];
            } else {
                todayKey = dayIndex === 0 ? "DOMINGO" : "SÁBADO";
            }
            return todayKey;
        }

        // Inicialización
        document.addEventListener('DOMContentLoaded', () => {
            createDaySelector();
            const today = getToday();
            if (weekDays.includes(today)) {
                renderRoutine(today);
            } else {
                renderRoutine("LUNES"); 
            }
        });
    </script>
</body>
</html>
